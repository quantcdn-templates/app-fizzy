#!/bin/bash
set -e

# Prepare database (create if missing, run pending migrations)
echo "Preparing database..."
MIGRATE=1 ./bin/rails db:prepare

# Start Solid Queue worker in background if RUN_WORKER is set
if [ "${RUN_WORKER:-false}" = "true" ]; then
  echo "Starting Solid Queue worker..."
  bundle exec rake solid_queue:start &
  WORKER_PID=$!
  trap "kill $WORKER_PID 2>/dev/null" EXIT
fi

# Start web server
exec ./bin/thrust ./bin/rails server
